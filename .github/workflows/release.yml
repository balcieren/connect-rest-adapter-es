name: Release & Publish

on:
  release:
    types: [published]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Integration test
        run: node dist/main.js --local test/fixtures --out test/output

  publish-npm:
    name: Publish to NPM
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Update version from release tag
        run: npm version ${{ github.event.release.tag_name }} --no-git-tag-version --allow-same-version

      - name: Commit and push updated version
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: bump version to ${{ github.event.release.tag_name }} [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.event.release.target_commitish }}

      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # NOTE: BSR plugin publishing requires Pro plan ($1000/month)
  # Uncomment when Pro plan is available
  # publish-buf:
  #   name: Publish to Buf Registry
  #   needs: test
  #   runs-on: ubuntu-latest
  #   continue-on-error: true
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Buf
  #       uses: bufbuild/buf-setup-action@v1
  #
  #     - name: Login to Buf Registry
  #       run: echo "${{ secrets.BUF_TOKEN }}" | buf registry login --token-stdin
  #
  #     - name: Update plugin version
  #       run: |
  #         VERSION=${{ github.event.release.tag_name }}
  #         sed -i "s/plugin_version: .*/plugin_version: $VERSION/" buf.plugin.yaml
  #
  #     - name: Build and export Docker image
  #       run: |
  #         docker build -t plugin:latest .
  #         docker save plugin:latest > image.tar
  #
  #     - name: Push plugin to BSR
  #       run: buf beta registry plugin push . --image image.tar --visibility public
